name: 价格监控系统

# 工作流用途：监控电商和比价网站的商品价格
# 每天自动运行，也可以通过自定义参数手动触发

on:
  schedule:
    # 每天 UTC 时间凌晨 2 点运行 (北京时间上午 10 点)
    - cron: '0 2 * * *'
  
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/price-monitoring.yml'
  
  workflow_dispatch:
    inputs:
      product-category:
        description: '监控的商品类别'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - baby
          - household
      
      site:
        description: '比价网站'
        required: false
        default: 'smzdm'
        type: choice
        options:
          - smzdm
          - manmanbuy
      
      debug-mode:
        description: '启用调试日志'
        required: false
        default: false
        type: boolean

# 全局环境变量
env:
  NODE_VERSION: '18'
  REPORTS_DIR: 'reports/price'

# 确保同一时间只有一个实例运行
concurrency:
  group: price-monitoring-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 任务 1: 环境设置与验证
  setup:
    name: 环境设置
    runs-on: ubuntu-latest
    
    outputs:
      should-run: ${{ steps.check.outputs.should_run }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 检查是否需要运行监控
        id: check
        run: |
          # 添加自定义逻辑来决定是否运行监控
          echo "should_run=true" >> $GITHUB_OUTPUT
  
  # 任务 2: 监控价格
  monitor-prices:
    name: 监控商品价格
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    
    strategy:
      matrix:
        site: [smzdm]
        # 可扩展: [smzdm, manmanbuy]
      fail-fast: false
      max-parallel: 2
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
      
      - name: 设置爬虫环境
        uses: ./.github/actions/setup-crawler
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 运行价格监控
        env:
          CI: true
          PROXY_URL: ${{ secrets.PROXY_URL }}
          DEBUG: ${{ inputs.debug-mode || 'false' }}
        run: |
          xvfb-run --auto-servernum \
            --server-args="-screen 0 1920x1080x24" \
            node src/scrapers/price-monitor.js \
            --site=${{ matrix.site }} \
            --category=${{ inputs.product-category || 'all' }} \
            --reportsDir=${{ env.REPORTS_DIR }}
      
      - name: 上传价格报告
        uses: ./.github/actions/upload-reports
        with:
          artifact-name: price-reports-${{ matrix.site }}-${{ github.run_number }}
          report-path: |
            ${{ env.REPORTS_DIR }}/*.json
            ${{ env.REPORTS_DIR }}/*.md
            ${{ env.REPORTS_DIR }}/*.png
          retention-days: 30
  
  # 任务 3: 生成汇总
  summary:
    name: 生成汇总报告
    runs-on: ubuntu-latest
    needs: monitor-prices
    if: always()
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: price-reports-*
          path: reports/aggregated
      
      - name: 生成汇总
        run: |
          echo "## 价格监控汇总" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**运行编号**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 在此处添加更多汇总逻辑
          echo "✅ 监控已完成" >> $GITHUB_STEP_SUMMARY
      
      - name: 上传聚合报告
        uses: ./.github/actions/upload-reports
        with:
          artifact-name: price-summary-${{ github.run_number }}
          report-path: reports/aggregated/**
          retention-days: 90
