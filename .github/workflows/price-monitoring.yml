name: 价格监控系统

# 工作流用途：监控电商和比价网站的商品价格
# 每天自动运行，也可以通过自定义参数手动触发

on:
  schedule:
    # 每天 UTC 时间凌晨 2 点运行 (北京时间上午 10 点)
    - cron: '0 2 * * *'
  
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/price-monitoring.yml'
  
  workflow_dispatch:
    inputs:
      product-category:
        description: '监控的商品类别'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - baby
          - household
      
      site:
        description: '比价网站'
        required: false
        default: 'smzdm'
        type: choice
        options:
          - smzdm
          - manmanbuy
      
      debug-mode:
        description: '启用调试日志'
        required: false
        default: false
        type: boolean

# 全局环境变量
env:
  NODE_VERSION: '18'
  REPORTS_DIR: 'reports/price'

# 权限控制：最小权限原则 (修改为 write 以允许提交数据)
permissions:
  contents: write

# 确保同一时间只有一个实例运行
concurrency:
  group: price-monitoring-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 任务 1: 环境设置与验证
  setup:
    name: 环境设置
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      should-run: ${{ steps.check.outputs.should_run }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 检查是否需要运行监控
        id: check
        run: |
          # 添加自定义逻辑来决定是否运行监控
          echo "should_run=true" >> $GITHUB_OUTPUT
  
  # 任务 2: 监控价格
  monitor-prices:
    name: 监控商品价格
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    timeout-minutes: 60
    
    strategy:
      matrix:
        site: [smzdm]
        # 可扩展: [smzdm, manmanbuy]
      fail-fast: false
      max-parallel: 2
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
      
      - name: 设置爬虫环境
        uses: ./.github/actions/setup-crawler
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 运行价格监控
        env:
          CI: true
          PROXY_URL: ${{ secrets.PROXY_URL }}
          DEBUG: ${{ inputs.debug-mode || 'false' }}
        run: |
          xvfb-run --auto-servernum \
            --server-args="-screen 0 1920x1080x24" \
            node src/scrapers/price-monitor.js \
            --site=${{ matrix.site }} \
            --category=${{ inputs.product-category || 'all' }} \
            --reportsDir=${{ env.REPORTS_DIR }}
      
      - name: 调试 - 列出生成的文件
        if: always()
        run: |
          echo "=== Listing reports directory ==="
          ls -R ${{ env.REPORTS_DIR }} || echo "Reports dir not found"
      
      - name: 上传价格报告
        uses: ./.github/actions/upload-reports
        with:
          artifact-name: price-reports-${{ matrix.site }}-${{ github.run_number }}
          report-path: |
            ${{ env.REPORTS_DIR }}/*.json
            ${{ env.REPORTS_DIR }}/*.md
            ${{ env.REPORTS_DIR }}/*.png
          retention-days: 30
  
  # 任务 3: 生成汇总并归档
  summary:
    name: 生成汇总并归档数据
    runs-on: ubuntu-latest
    needs: monitor-prices
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: price-reports-*
          path: temp_reports
          
      - name: 调试 - 列出下载的文件
        run: |
          echo "=== Listing temp_reports directory ==="
          ls -R temp_reports || echo "temp_reports not found"
      
      - name: 推送企业微信通知
        if: always()
        continue-on-error: true
        run: |
          # 检查 Secrets 是否存在
          if [ -z "${{ secrets.WECOM_CORPID }}" ]; then
            echo "未配置 WECOM_CORPID，跳过微信通知"
            exit 0
          fi
          
          # 1. 获取 Access Token
          TOKEN_RES=$(curl -s "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${{ secrets.WECOM_CORPID }}&corpsecret=${{ secrets.WECOM_SECRET }}")
          ACCESS_TOKEN=$(echo $TOKEN_RES | jq -r .access_token)
          
          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "获取 Access Token 失败: $TOKEN_RES"
            exit 1
          fi
          
          # 2. 生成详细报告内容
          REPORT_FILE=$(find temp_reports -name "price-report.json" | head -n 1)
          DETAILS=""
          
          if [ -f "$REPORT_FILE" ]; then
            # 使用 jq 提取每个商品的最低价，生成简洁列表
            # 格式: > 商品名: ¥价格
            DETAILS=$(jq -r '.categories[] | .products[] | select(.success) | "> " + .product + ": ¥" + (.minPrice|tostring)' "$REPORT_FILE" | head -n 10)
            
            if [ -z "$DETAILS" ]; then
              DETAILS="未找到有效价格数据"
            fi
          else
            DETAILS="未找到报告文件"
          fi
          
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%m-%d %H:%M')
          STATUS_ICON="✅"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS_ICON="❌"
          fi
          
          # 构建最终消息
          MSG_CONTENT="$STATUS_ICON 监控完成 #${{ github.run_number }}
          时间: $CURRENT_DATE
          
          $DETAILS
          
          链接: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # 3. 发送消息
          curl -s -X POST "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$ACCESS_TOKEN" \
            -H 'Content-Type: application/json' \
            -d "{
              \"touser\": \"${{ secrets.WECOM_USERID }}\",
              \"msgtype\": \"text\",
              \"agentid\": \"${{ secrets.WECOM_AGENTID }}\",
              \"text\": {
                \"content\": \"$MSG_CONTENT\"
              }
            }"
      
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: price-reports-*
          path: temp_reports
      
      - name: 归档数据到仓库
        run: |
          # 获取当前日期 (北京时间)
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          TARGET_DIR="data/$CURRENT_DATE"
          
          # 创建目标目录
          mkdir -p $TARGET_DIR
          
          # 移动报告文件
          # 注意：download-artifact 会为每个 artifact 创建子目录，我们需要把它们展平或整理
          cp -r temp_reports/*/* $TARGET_DIR/ 2>/dev/null || true
          
          # 配置 git
          git config --global user.name 'GitHub Action Price Monitor'
          git config --global user.email 'action@github.com'
          
          # 添加并提交
          git add $TARGET_DIR
          
          # 只有在有变化时才提交
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-archive price data for $CURRENT_DATE"
            git push
          fi

      - name: 生成汇总
        run: |
          echo "## 价格监控汇总" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**运行编号**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ 监控已完成，数据已归档至 \`data/$(TZ='Asia/Shanghai' date +'%Y-%m-%d')\`" >> $GITHUB_STEP_SUMMARY
      
      - name: 上传聚合报告
        uses: ./.github/actions/upload-reports
        with:
          artifact-name: price-summary-${{ github.run_number }}
          report-path: temp_reports/**
          retention-days: 90
